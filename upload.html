<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø±ÙØ¹ CSV â€“ TVTC BI</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Cairo',sans-serif;background:#f3f5f9;padding:40px;text-align:center;}
.card{background:#fff;padding:25px;border-radius:16px;max-width:480px;margin:auto;
      box-shadow:0 4px 12px rgba(0,0,0,.1);}
input,button{width:100%;padding:12px;border-radius:10px;margin-top:15px;font-size:15px;}
button{background:#0b3c5d;border:none;color:#fff;cursor:pointer;}
#msg{margin-top:20px;font-size:14px;font-weight:700;}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBOoR93CxFz31TF6aae97HS1XWFCS8K_GI",
  authDomain: "mct-bi.firebaseapp.com",
  databaseURL: "https://mct-bi-default-rtdb.firebaseio.com",
  projectId: "mct-bi",
  storageBucket: "mct-bi.firebasestorage.app",
  messagingSenderId: "1037778823546",
  appId: "1:1037778823546:web:724648031792ef6f5e4ec3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function clean(t){return t.replace(/\s/g,"").trim();}
function findIndex(h,k){
  k = clean(k);
  for(let i=0;i<h.length;i++){ if(clean(h[i]).includes(k)) return i; }
  return -1;
}
function extractTermKey(text){
  if(!text) return null;
  let year = text.match(/\d{4}/);
  if(!year) return null;
  let term = text.includes("Ø§Ù„Ø«Ø§Ù†ÙŠ") ? "T2" : "T1";
  return `${year[0]}-${term}`;
}

async function uploadCSV(){
  let file = document.getElementById("csv").files[0];
  if(!file){alert("Ø§Ø®ØªØ± Ù…Ù„Ù CSV");return;}

  let raw = await file.text();
  let rows = raw.split(/\r?\n/).filter(r=>r.trim()!=="");

  let header = rows[0].split(",");

  let idx = {
    hours: findIndex(header,"Ø³.Ù…Ø¹ØªÙ…Ø¯Ø©"),
    crn: findIndex(header,"Ø§Ù„Ø±Ù‚Ù…Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ"),
    cname: findIndex(header,"Ø§Ø³Ù…Ø§Ù„Ù…Ù‚Ø±Ø±"),
    ccode: findIndex(header,"Ø§Ù„Ù…Ù‚Ø±Ø±"),
    sname: findIndex(header,"Ø§Ø³Ù…"),
    sid: findIndex(header,"Ø±Ù‚Ù…Ø§Ù„Ø·Ø§Ù„Ø¨"),
    major: findIndex(header,"Ø§Ù„ØªØ®ØµØµ"),
    dept: findIndex(header,"Ø§Ù„Ù‚Ø³Ù…"),
    term: findIndex(header,"Ø§Ù„ÙØµÙ„Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ")
  };

  let list = [];
  let termKey = null;

  for(let i=1;i<rows.length;i++){
    let c = rows[i].split(",");
    if(c.length<10) continue;

    let termCell = c[idx.term];
    if(!termKey) termKey = extractTermKey(termCell);

    list.push({
      approved_hours: c[idx.hours],
      crn: c[idx.crn],
      course_name: c[idx.cname],
      course_code: c[idx.ccode],
      student_name: c[idx.sname],
      student_id: c[idx.sid],
      major: c[idx.major],
      department: c[idx.dept],
      term: termCell,
      term_key: termKey
    });
  }

  if(!termKey){
    document.getElementById("msg").innerHTML = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ";
    return;
  }

  await db.ref("terms/"+termKey).set(list);

  document.getElementById("msg").innerHTML =
    "âœ” ØªÙ… Ø±ÙØ¹ " + list.length + " Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„: " + termKey;
}
</script>

</head>
<body>
<div class="card">
<h2>ğŸ“¤ Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª CSV</h2>
<input type="file" id="csv" accept=".csv">
<button onclick="uploadCSV()">Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
<div id="msg"></div>
</div>
</body>
</html>